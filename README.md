# SelfDrivingCar3-PathPlanner1
The second version of the path planner. Strictly no jerk!

## Problem
The problem with this planner is that it will not only have to be safe (no collisions in traffic), but it will also have to be able to produce curves with strictly bounded jerk, acceleration and speed. Makes you wonder about the trade-off between the suddent use of breaks in order to save lives :).

The actual challenge here is that the map is essentially a polygon with waypoints sitting on its vertices and converting splines from s-d coordinates to world coordinates will produce discontinuous curves. Thus, the only work-around is to generate sparse s-d points and thereafter interpolate in some coordinate frame that can be transformed analytically to the world reference. In this version of the planner ( see also my other attempt [here](https://github.com/terzakig/SelfDrivingCar3-PathPlanner) ), interpolation occurs in the car's local coordinate frame and from the results, this allows us to achieve continuity, possibly to the maximum possible extent in the context of this particular  problem.

## Performance
In my view, the planner is safe and it changes lanes through traffic. The only dark spot I have encountered is that when it has decided to change its lane, it sometimes attempts to do so from a low speed level and that **VERY RARELY** results in an **annoying** alert for acceleration. Other than that, although not particularly aggressive in traffic, it is fast and can beat the 4.32 miles without incident requirement. 

## Trajectory Interpolation
Any planned trajectory initially comprises a few (3 in particular) sparse s-d points, plus a few points that belong to the end of the previous plan, as returned by the simulator. The idea here is to transform all these points to the car's local coordinate frame and thereafter fit a spline parametrized by distance along the longitudinal axis of the car. This way, we **may assume that the spline curve can be approximated by the linear segment that connects its end-points**. This assumption, **although not correct and can potentially lead to extreme problems**, works better than anything else I have tried so far in allowing us to control the speed and acceleration, almost to a point where no annoying (to say the least) alerts are given by the simulator. The idea is to partition the segment into small displacements determined by the speed level and thereafter project them on the axis to get the valuie for the parameter. Thus, for these parameter values, we obtain the respective spline values, convert the points to global coordinates and feed them to the simulator. And it actually works! No more jerk/acceleration alerts! There is a **catch** however: This magical straihght line approximation is not valid at all times, although in this track it is (and only for a magic number of 3 sparse s-d points). Reason being, **try to imagine a sharp turn that the car is about to enter**: This means that the planned trajectory will not be a function in the local coordinate frame of the car, since it will bend backwards along the local x-axis and therefore many x-values will have two (or more) corresponding values in the y-axis. The [spline tool](http://kluge.in-chemnitz.de/opensource/spline/) has various checks and assertions in order to avioud such situation.

A more elegant idea would be to generate x and y splines (see my other planner write-up [here](https://github.com/terzakig/SelfDrivingCar3-PathPlanner/blob/master/writeup_report.pdf) ) in the world frame and parametrize them with arc-length. Although this is more robust to sharp turns in the track, computing arc length will have to rely on linear segments once again, which in turn will introduce sharp acceleration changes, especially when the road is turning.

Perhaps the best solution of it all would be to fit a spline to the track, thereby circumventing the discontinuities carried over by the `getXY()` function from the piecewise linear track map. This way, it will be easy to generate the spline directly in s-d coordinates and then simply reparametrize it with arc length in world coordinates. 

## The planner
The planner is relatively simple. It contemplates whether it should increase/decrease speed and change lane. Increasing/decreasing the target speed depends heavily on potential collisions. It slows down if a collision with a vehicle ahead is imminent, while it accelerates to avoid being hit from behind by a trailing vehicle. Changing lanes on the other hand is a slightly more elaborate automaton: The planner keeps track of a _low-speed counter_ correpsonding to the times it reduces speed to avoid a potential collision and when it overflows, it increases am _incident counter_ (unrelated to the correpsonding simulator "incidents"). If the incident counter reaches 3 in the same lane, then a `doLaneChange` flag is issued and the planner is condemned to find a new lane, even if it takes forever. This is the simple logic of lane-changing. If our speed has been diminished by another vehicle 3 times in the same lane, than it is better to look for another one. In practice, this is a conservative attitude, but it appears to be safe.    
